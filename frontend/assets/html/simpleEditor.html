<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>拼图预览</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .preview-main {
            max-width: 900px;
            margin: 40px auto;
            display: flex;
            gap: 32px;
            flex-wrap: wrap;
        }
        .preview-left, .preview-right {
            flex: 1;
            min-width: 320px;
        }
        .preview-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 24px;
            margin-bottom: 24px;
        }
        .preview-upload-box {
            border: 2px dashed #E5E7EB;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
        }
        .preview-img {
            width: 100%;
            border-radius: 8px;
            display: block;
            margin-bottom: 12px;
        }
        .preview-grid-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
        }
        .preview-img-box {
            position: relative;
            width: 100%;
            min-height: 240px;
            background: #F9FAFB;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .preview-btn-row {
            text-align: center;
            margin-top: 24px;
        }
    </style>
</head>
<body>
<div class="background-blur"></div>
    <div class="page-title">
        <i class="fa fa-arrow-left back-btn" onclick="window.location.href='menu.html'"></i>
        <span>预览拼图</span>
    </div>
    <div class="preview-main">
        <!-- 左侧：上传和配置 -->
        <div class="preview-left">
            <div class="preview-card">
                <h3 style="font-size: 16px; margin-bottom: 16px;">上传图片</h3>
                <div class="preview-upload-box" id="uploadBox">
                    <i class="fa fa-cloud-upload" style="font-size: 32px; color: #165DFF; margin-bottom: 12px;"></i>
                    <p style="font-size: 14px; color: #666;">点击或拖拽图片上传（JPG/PNG，最大5MB）</p>
                    <input type="file" id="imageUpload" accept="image/*" style="display:none;">
                </div>
            </div>
            <div class="preview-card">
                <h3 style="font-size: 16px; margin-bottom: 16px;">拼图配置</h3>
                <div class="input-item">
                    <label>拼图块数</label>
                    <select id="difficultySelect">
                        <option value="3">3 x 3</option>
                        <option value="4" selected>4 x 4</option>
                        <option value="5">5 x 5</option>
                        <option value="6">6 x 6</option>
                        <option value="8">8 x 8</option>
                    </select>
                </div>
            </div>
        </div>
        <!-- 右侧：预览区 -->
        <div class="preview-right">
            <div class="preview-card">
                <h3 style="font-size: 16px; margin-bottom: 16px;">拼图预览</h3>
                <div class="preview-img-box" id="previewImgBox">
                    <img id="previewImage" class="preview-img" src="" alt="预览图" style="display:none;">
                    <canvas id="gridCanvas" class="preview-grid-canvas" style="display:none;"></canvas>
                    <p id="previewTip" style="color:#666;">上传图片并选择块数后预览效果</p>
                </div>
                <div style="margin-top: 16px; text-align: right;">
                    <p style="font-size: 14px; color: #666;">预计难度：<span id="difficultyText">简单</span></p>
                </div>
                <div class="preview-btn-row">
                    <button id="playBtn" class="btn btn-primary" disabled>开始游戏</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // 控件
        const uploadBox = document.getElementById('uploadBox');
        const imageUpload = document.getElementById('imageUpload');
        const previewImage = document.getElementById('previewImage');
        const gridCanvas = document.getElementById('gridCanvas');
        const difficultySelect = document.getElementById('difficultySelect');
        const playBtn = document.getElementById('playBtn');
        const previewTip = document.getElementById('previewTip');
        const difficultyText = document.getElementById('difficultyText');
        let imgData = null;

        // 上传图片
        uploadBox.onclick = () => imageUpload.click();
        uploadBox.addEventListener('dragover', e => { e.preventDefault(); uploadBox.style.borderColor = "#165DFF"; });
        uploadBox.addEventListener('dragleave', e => { e.preventDefault(); uploadBox.style.borderColor = "#E5E7EB"; });
        uploadBox.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadBox.style.borderColor = "#E5E7EB";
            if (e.dataTransfer.files.length > 0) {
                imageUpload.files = e.dataTransfer.files;
                handleImage();
            }
        });
        imageUpload.addEventListener('change', handleImage);

        function handleImage() {
            if (imageUpload.files.length > 0) {
                const file = imageUpload.files[0];
                if (file.size > 5 * 1024 * 1024) {
                    alert('图片太大，请选择小于5MB的图片');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    imgData = e.target.result;
                    previewImage.src = imgData;
                    previewImage.style.display = 'block';
                    gridCanvas.style.display = 'block';
                    previewTip.style.display = 'none';
                    drawGrid();
                    playBtn.disabled = false;
                };
                reader.readAsDataURL(file);
            }
        }

        // 难度文字
        function updateDifficultyText() {
            const val = parseInt(difficultySelect.value);
            let txt = '简单';
            if (val >= 5 && val < 8) txt = '中等';
            if (val >= 8) txt = '困难';
            difficultyText.textContent = txt;
        }
        difficultySelect.addEventListener('change', () => {
            drawGrid();
            updateDifficultyText();
        });
        updateDifficultyText();

        // 绘制网格
        function drawGrid() {
            if (!imgData) return;
            previewImage.onload = function() {
                gridCanvas.width = previewImage.width;
                gridCanvas.height = previewImage.height;
                gridCanvas.style.width = previewImage.width + 'px';
                gridCanvas.style.height = previewImage.height + 'px';
                const ctx = gridCanvas.getContext('2d');
                ctx.clearRect(0, 0, gridCanvas.width, gridCanvas.height);
                ctx.strokeStyle = "#FFFFFF";
                ctx.lineWidth = 2;
                const grid = parseInt(difficultySelect.value);
                // 竖线
                for (let i = 1; i < grid; i++) {
                    let x = i * gridCanvas.width / grid;
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, gridCanvas.height);
                    ctx.stroke();
                }
                // 横线
                for (let i = 1; i < grid; i++) {
                    let y = i * gridCanvas.height / grid;
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(gridCanvas.width, y);
                    ctx.stroke();
                }
            };
            previewImage.src = imgData;
        }

        // 开始游戏
        playBtn.addEventListener('click', function() {
            localStorage.setItem('customImage', imgData);
            localStorage.setItem('customSize', difficultySelect.value);
            window.location.href = 'index.html';
        });

        window.addEventListener('DOMContentLoaded', function() {
        const customImage = localStorage.getItem('customImage');
        const customSize = localStorage.getItem('customSize');
        if (customImage && customSize) {
            imgData = customImage;
            previewImage.src = imgData;
            previewImage.style.display = 'block';
            gridCanvas.style.display = 'block';
            previewTip.style.display = 'none';
            difficultySelect.value = customSize;
            updateDifficultyText();
            drawGrid();
            playBtn.disabled = false;
            // 清除 localStorage，避免下次重复
            localStorage.removeItem('customImage');
            localStorage.removeItem('customSize');
        }
    });
    </script>
</body>
</html>